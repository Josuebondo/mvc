#!/usr/bin/env php
<?php

/**
 * BondoMVC Console - G√©n√©rateur de code
 * Usage: php console make:controller NomController
 */

$command = $argv[1] ?? null;
$argument = $argv[2] ?? null;

if (!$command || !$argument) {
    echo "BondoMVC Console\n";
    echo "Usage: php console [command] [name]\n\n";
    echo "Commands:\n";
    echo "  make:controller <name>  - Cr√©er un contr√¥leur\n";
    echo "  make:model <name>       - Cr√©er un mod√®le\n";
    echo "  make:middleware <name>  - Cr√©er un middleware\n";
    exit(1);
}

[$type, $name] = explode(':', $command);

if ($type !== 'make') {
    echo "‚ùå Commande invalide\n";
    exit(1);
}

switch ($name) {
    case 'controller':
        createController($argument);
        break;
    case 'model':
        createModel($argument);
        break;
    case 'middleware':
        createMiddleware($argument);
        break;
    default:
        echo "‚ùå Type invalide: $name\n";
        exit(1);
}

function createController($name)
{
    $path = __DIR__ . "/app/controllers/{$name}.php";

    if (file_exists($path)) {
        echo "‚ùå Le contr√¥leur $name existe d√©j√†!\n";
        exit(1);
    }

    $content = <<<PHP
<?php

namespace App\Controllers;

use Core\Controller;

class {$name} extends Controller
{
    public function index()
    {
        \$this->view('{' . strtolower($name) . '}/index');
    }
}
PHP;

    file_put_contents($path, $content);
    echo "‚úì Contr√¥leur cr√©√©: app/controllers/{$name}.php\n";
}

function createModel($name)
{
    $path = __DIR__ . "/app/models/{$name}.php";

    if (file_exists($path)) {
        echo "‚ùå Le mod√®le $name existe d√©j√†!\n";
        exit(1);
    }

    $table = strtolower($name) . 's';
    $content = <<<PHP
<?php

namespace App\Models;

use Core\Model;

class {$name} extends Model
{
    protected string \$table = '{$table}';

    public function getAll()
    {
        return \$this->db()->fetchAll("SELECT * FROM {\$this->table}");
    }

    public function getById(\$id)
    {
        return \$this->db()->fetch("SELECT * FROM {\$this->table} WHERE id = ?", [\$id]);
    }

    public function create(\$data)
    {
        return \$this->db()->insert(\$this->table, \$data);
    }

    public function update(\$id, \$data)
    {
        return \$this->db()->update(\$this->table, \$data, ['id' => \$id]);
    }

    public function delete(\$id)
    {
        return \$this->db()->delete(\$this->table, ['id' => \$id]);
    }
}
PHP;

    file_put_contents($path, $content);
    echo "‚úì Mod√®le cr√©√©: app/models/{$name}.php\n";
    echo "üí° N'oublie pas de cr√©er la table: {$table}\n";
}

function createMiddleware($name)
{
    $path = __DIR__ . "/app/middleware/{$name}.php";

    if (file_exists($path)) {
        echo "‚ùå Le middleware $name existe d√©j√†!\n";
        exit(1);
    }

    $content = <<<PHP
<?php

namespace App\Middleware;

use Core\Middleware;

class {$name} extends Middleware
{
    public function handle(): bool
    {
        // Votre logique ici
        
        return true; // Continuer
        // return false; // Arr√™ter
    }
}
PHP;

    file_put_contents($path, $content);
    echo "‚úì Middleware cr√©√©: app/middleware/{$name}.php\n";
}
