#!/usr/bin/env php
<?php
/**
 * BondoMVC Artisan-like CLI Tool
 * Similar to Laravel's artisan command
 */

use Core\Migration;

if (php_sapi_name() !== 'cli') {
    die('This script can only be run from the command line.');
}

$command = $argv[1] ?? null;
$argument = $argv[2] ?? null;

if (!$command || in_array($command, ['--help', '-h', 'help'])) {
    showHelp();
    exit(0);
}

// Routes des commandes
switch ($command) {
    case 'serve':
        serveCommand($argument);
        break;
    case 'make:controller':
        makeController($argument);
        break;
    case 'make:model':
        makeModel($argument);
        break;
    case 'make:middleware':
        makeMiddleware($argument);
        break;
    case 'migrate':
        migrateCommand();
        break;
    case 'migrate:rollback':
        migrateRollback();
        break;
    case 'migrate:refresh':
        migrateRefresh();
        break;
    case 'make:migration':
        makeMigration($argument);
        break;
    case 'tinker':
        tinkerCommand();
        break;
    default:
        echo "‚ùå Commande inconnue: $command\n\n";
        showHelp();
        exit(1);
}

// ============================================
// COMMANDE: serve
// ============================================
function serveCommand($port = null)
{
    $port = $port ?: '8000';
    $host = 'localhost';

    echo "\nüöÄ BondoMVC Development Server\n";
    echo "================================\n\n";
    echo "Server running at: http://$host:$port\n";
    echo "Press Ctrl+C to stop the server\n\n";

    $command = "php -S $host:$port";

    if (PHP_OS_FAMILY === 'Windows') {
        system($command);
    } else {
        passthru($command);
    }
}

// ============================================
// COMMANDE: make:controller
// ============================================
function makeController($name)
{
    if (!$name) {
        echo "‚ùå Usage: php artisan make:controller NomController\n";
        exit(1);
    }

    $path = __DIR__ . "/app/controllers/{$name}.php";

    if (file_exists($path)) {
        echo "‚ùå Controller $name already exists!\n";
        exit(1);
    }

    $stub = <<<PHP
<?php

namespace App\Controllers;

use Core\Controller;

class {$name} extends Controller
{
    public function index()
    {
        \$this->view('{strtolower($name)}/index');
    }
}
PHP;

    file_put_contents($path, $stub);
    echo "‚úì Controller created: app/controllers/{$name}.php\n";
    echo "üí° Create view: app/views/" . strtolower($name) . "/index.php\n";
}

// ============================================
// COMMANDE: make:model
// ============================================
function makeModel($name)
{
    if (!$name) {
        echo "‚ùå Usage: php artisan make:model NomModel\n";
        exit(1);
    }

    $path = __DIR__ . "/app/models/{$name}.php";

    if (file_exists($path)) {
        echo "‚ùå Model $name already exists!\n";
        exit(1);
    }

    $table = strtolower($name) . 's';
    $stub = <<<PHP
<?php

namespace App\Models;

use Core\Model;

class {$name} extends Model
{
    protected string \$table = '{$table}';

    public function getAll()
    {
        return \$this->db()->fetchAll("SELECT * FROM {\$this->table}");
    }

    public function getById(\$id)
    {
        return \$this->db()->fetch("SELECT * FROM {\$this->table} WHERE id = ?", [\$id]);
    }

    public function create(\$data)
    {
        return \$this->db()->insert(\$this->table, \$data);
    }

    public function update(\$id, \$data)
    {
        return \$this->db()->update(\$this->table, \$data, ['id' => \$id]);
    }

    public function delete(\$id)
    {
        return \$this->db()->delete(\$this->table, ['id' => \$id]);
    }
}
PHP;

    file_put_contents($path, $stub);
    echo "‚úì Model created: app/models/{$name}.php\n";
    echo "üí° Create table: {$table}\n";
}

// ============================================
// COMMANDE: make:middleware
// ============================================
function makeMiddleware($name)
{
    if (!$name) {
        echo "‚ùå Usage: php artisan make:middleware NomMiddleware\n";
        exit(1);
    }

    $path = __DIR__ . "/app/middleware/{$name}.php";

    if (file_exists($path)) {
        echo "‚ùå Middleware $name already exists!\n";
        exit(1);
    }

    $stub = <<<PHP
<?php

namespace App\Middleware;

use Core\Middleware;

class {$name} extends Middleware
{
    public function handle(): bool
    {
        // Your logic here
        
        return true;  // Continue
        // return false;  // Stop
    }
}
PHP;

    file_put_contents($path, $stub);
    echo "‚úì Middleware created: app/middleware/{$name}.php\n";
}

// ============================================
// COMMANDE: migrate
// ============================================
function migrateCommand()
{
    require __DIR__ . '/config/config.php';
    
    $migration = new Migration();
    $migration->runMigrations();
}

// ============================================
// COMMANDE: migrate:rollback
// ============================================
function migrateRollback()
{
    require __DIR__ . '/config/config.php';
    
    $migration = new Migration();
    $migration->rollback();
}

// ============================================
// COMMANDE: migrate:refresh
// ============================================
function migrateRefresh()
{
    require __DIR__ . '/config/config.php';
    
    echo "üîÑ Refreshing migrations...\n";
    
    $migration = new Migration();
    
    // Rollback all
    while (true) {
        try {
            $migration->rollback();
        } catch (\Exception $e) {
            break;
        }
    }
    
    // Run all
    $migration->runMigrations();
}

// ============================================
// COMMANDE: make:migration
// ============================================
function makeMigration($name)
{
    if (!$name) {
        echo "‚ùå Usage: php artisan make:migration MigrationName\n";
        exit(1);
    }

    $timestamp = date('Y_m_d_His');
    $filename = "{$timestamp}_{$name}.php";
    $path = __DIR__ . "/database/migrations/{$filename}";

    $className = str_replace('_', '', ucwords($name, '_'));

    $stub = <<<PHP
<?php

namespace Database\Migrations;

use Core\Database;

/**
 * Migration: {$name}
 */
class {$className} extends Migration
{
    public function up(Database \$db)
    {
        // TODO: Create your table
        // \$sql = "CREATE TABLE table_name (...)";
        // \$db->getConnection()->exec(\$sql);
    }

    public function down(Database \$db)
    {
        // TODO: Drop your table
        // \$db->getConnection()->exec("DROP TABLE IF EXISTS table_name");
    }
}
PHP;

    file_put_contents($path, $stub);
    echo "‚úì Migration created: database/migrations/{$filename}\n";
    echo "üí° Edit the file and run: php artisan migrate\n";
}

// ============================================
    echo "========================================\n\n";
    echo "Type 'exit' or 'quit' to exit\n";
    echo "Example: \$model = new \\App\\Models\\User();\n\n";

    // Simple REPL
    $history = [];

    while (true) {
        echo ">>> ";
        $line = trim(fgets(STDIN));

        if (in_array($line, ['exit', 'quit'])) {
            echo "Goodbye!\n";
            break;
        }

        if (empty($line)) {
            continue;
        }

        try {
            ob_start();
            eval('?' . '>' . $line . ';');
            $output = ob_get_clean();

            if ($output) {
                echo $output . "\n";
            }

            $history[] = $line;
        } catch (Exception $e) {
            echo "Error: " . $e->getMessage() . "\n";
        }
    }
}

// ============================================
// AIDE
// ============================================
function showHelp()
{
    echo "\nüìö BondoMVC Artisan CLI\n";
    echo "=======================\n\n";
    echo "Usage: php artisan <command> [options]\n\n";
    echo "Available Commands:\n\n";

    echo "  serve [port]                  Start development server (default: 8000)\n";
    echo "    php artisan serve\n";
    echo "    php artisan serve 3000\n\n";

    echo "  make:controller <name>        Create a new controller\n";
    echo "    php artisan make:controller ProductController\n\n";

    echo "  make:model <name>             Create a new model\n";
    echo "    php artisan make:model Product\n\n";

    echo "  make:middleware <name>        Create a new middleware\n";
    echo "    php artisan make:middleware AdminMiddleware\n\n";

    echo "  make:migration <name>         Create a new migration\n";
    echo "    php artisan make:migration CreateUsersTable\n\n";

    echo "  migrate                       Run pending migrations\n";
    echo "    php artisan migrate\n\n";

    echo "  migrate:rollback              Rollback last migration batch\n";
    echo "    php artisan migrate:rollback\n\n";

    echo "  migrate:refresh               Rollback all and re-run migrations\n";
    echo "    php artisan migrate:refresh\n\n";

    echo "  tinker                        Interactive PHP shell\n";
    echo "    php artisan tinker\n\n";

    echo "  help, --help, -h              Show this help message\n\n";
}
?>